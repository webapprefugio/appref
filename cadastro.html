<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Cadastrar | WebApp Refúgios</title>
    <!-- jQuery (obrigatório para Select2) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <!-- CSS do Select2 -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <!-- JS do Select2 -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link rel="icon" href="assets/img/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="style/stylecss.css" />
    <style>
      :root {
        --primary: #238636;
        --secondary: #0d1117;
        --text: #c9d1d9;
        --radius: 12px;
        --container-bg: #161b22;
        --container-border: #30363d;
        --button-bg: #238636;
        --button-bg-hover: #2ea043;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        background: var(--secondary);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
      }
      .container {
        background: var(--container-bg);
        border-radius: var(--radius);
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.07);
        border: 1px solid var(--container-border);
        max-width: 480px;
        min-width: 320px;
        width: 100%;
        padding: 2rem;
        margin: 1rem 0;
        text-align: center;
      }
      h1 {
        font-size: 2.2rem;
        margin-bottom: 1rem;
        color: #fff;
      }
      p {
        font-size: 1.1rem;
        margin-bottom: 1.5em;
        color: #8b949e;
      }
      button {
        background: var(--button-bg);
        color: #fff;
        border: none;
        border-radius: var(--radius);
        padding: 0.8rem 2rem;
        font-size: 1rem;
        cursor: pointer;
        transition: background 0.2s;
      }
      button:hover {
        background: var(--button-bg-hover);
      }
      .alt-btn {
        background: #30363d;
        color: #c9d1d9;
      }
      .alt-btn:hover {
        background: #22262c;
      }
      .formulario {
        margin-top: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .formulario input,
      .formulario select {
        padding: 0.7rem;
        border-radius: 8px;
        border: 1px solid var(--container-border);
        background: #0d1117;
        color: var(--text);
        transition: border 0.2s;
      }
      .formulario input:focus,
      .formulario select:focus {
        border: 1.5px solid var(--primary);
        outline: none;
      }
      .formulario select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        cursor: pointer;
      }
      .formulario select option {
        color: #f9f3f3;
        background: #0d1117;
      }
      a {
        text-decoration: none;
      }
      #campo-cidades {
        width: 95%;
        background: #0d1117;
        border: 1px solid var(--container-border);
        border-radius: 8px;
        padding: 0.5em 0.7em;
        margin-bottom: 0.2em;
        min-height: 1.3em;
        max-height: 8.5em;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.2em;
      }
      @media (max-width: 600px) {
        .container {
          padding: 1rem;
          max-width: 98vw;
        }
        h1 {
          font-size: 1.4rem;
        }
        p {
          font-size: 1rem;
        }
      }
      @media (max-width: 400px) {
        .container {
          padding: 0.5rem;
        }
        h1 {
          font-size: 1.1rem;
        }
      }
      @media (max-width: 320px) {
        body,
        html {
          min-width: 320px;
          overflow-x: auto;
        }
        .container {
          min-width: 320px;
        }
      }
    </style>
  </head>
  <body>
    <div id="menu"></div>
    <script src="js/menu-loader.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        fetch("menu.html")
          .then((res) => res.text())
          .then((html) => {
            document.getElementById("menu").innerHTML = html;
            const currentPage = location.pathname.split("/").pop();
            document.querySelectorAll(".nav-links a").forEach((link) => {
              if (link.getAttribute("href") === currentPage) {
                link.classList.add("active");
              }
            });
          })
          .catch((err) => console.error("Erro ao carregar menu:", err));
      });
    </script>
    <main>
      <div class="container">
        <h1>Cadastre-se</h1>
        <form class="formulario" id="formCadastro">
          <div>
            <input type="checkbox" id="chkTermos" required />
            &nbsp;&nbsp;Concordo com os
            <a href="termos.html" style="color: #df5252">&nbsp;Termos de uso e Condições</a>
          </div>
          <input
            type="text"
            placeholder="Link do seu Perfil Social"
            required
            id="txtPerfilSocial"
          />
          <input type="text" placeholder="Nome de usuário" required id="txtNome" />
          <input type="email" placeholder="E-mail" required id="txtEmail" />
          <input type="password" placeholder="Senha" required id="txtSenha" />
          <label
            for="perguntaSeguranca"
            style="margin-top: 0.5em; color: #8b949e; font-size: 0.95rem"
            >Pergunta de Segurança</label
          >
          <input
            type="text"
            placeholder="Pergunte o que só você saberá responder"
            required
            id="txtPerguntaSeguranca"
          />
          <input
            type="text"
            placeholder="Resposta à pergunta de segurança"
            required
            id="txtRespostaSeguranca"
          />
          <label
            for="lstUf"
            style="margin-top: 0.5em; color: #8b949e; font-size: 0.95rem"
            >Locais dos Refúgios</label
          >
          <select id="lstUf" required style="color: #75797e">
            <option value="" disabled selected>Selecione um Estado</option>
          </select>
          <div id="campo-cidades">
            <span
              id="msg-cidade-placeholder"
              style="
                color: #75797e;
                font-size: 0.9rem;
                text-align: left;
                display: block;
                padding: 0;
                margin: 0;
              "
              >Selecione uma cidade</span
            >
          </div>
          <div
            id="msg-cidade-info"
            style="
              display: none;
              color: var(--primary);
              font-size: 0.75rem;
              font-weight: 600;
              margin-bottom: 0.5em;
              text-align: left;
            "
          >
            Selecione no máximo 3 cidades
          </div>
          <div
            id="mensagem"
            style="
              min-height: 1.5em;
              color: #df5252;
              font-size: 1.05rem;
              margin-bottom: 0.5em;
            "
          ></div>
          <button type="submit">Cadastrar</button>
          <button
            type="button"
            class="alt-btn"
            style="margin-top: 0.5rem"
            onclick="window.location.href='index.html'"
          >
            Cancelar
          </button>
          <p style="margin-top: 1.2rem; color: #8b949e; font-size: 1rem">
            Já possui uma conta?
            <a href="login.html" style="color: var(--primary)">Entrar</a>
          </p>
        </form>
      </div>
    </main>
    <script>
      // Forçar sugestões no select2 se for usado (não usado atualmente)
      function forcarSugestoes(input) {
        const valor = input.value;
        input.value = "";
        setTimeout(() => {
          input.value = valor;
        }, 1);
      }

      // Função para normalizar a resposta da pergunta de segurança
      function limparRespostaSeguranca(valor) {
        return valor
          .normalize("NFD") // separa acentos
          .replace(/[\u0300-\u036f]/g, "") // remove acentos
          .replace(/\s+/g, "") // remove espaços
          .toLowerCase(); // letras minúsculas
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Carregando menu já feito acima

        // Elementos
        const lstUf = document.getElementById("lstUf");
        const campoCidades = document.getElementById("campo-cidades");
        const msgCidadeInfo = document.getElementById("msg-cidade-info");
        const mensagem = document.getElementById("mensagem");
        const form = document.getElementById("formCadastro");

        let cidadesPorUF = {};

        // Carregar JSONs com estados e cidades
        Promise.all([
          fetch("json/ufs.json").then((res) => res.json()),
          fetch("json/cidades.json").then((res) => res.json()),
        ])
          .then(([estados, cidades]) => {
            const stateIdToAbbr = {};
            estados
              .sort((a, b) => a.name.localeCompare(b.name, "pt-BR"))
              .forEach((estado) => {
                stateIdToAbbr[estado.id] = estado.abbr;
                const opt = document.createElement("option");
                opt.value = estado.abbr;
                opt.textContent = estado.name;
                lstUf.appendChild(opt);
              });

            cidades.forEach((cidade) => {
              const uf = stateIdToAbbr[cidade.state_id];
              if (!uf) return;
              if (!cidadesPorUF[uf]) cidadesPorUF[uf] = [];
              cidadesPorUF[uf].push(cidade.name);
            });

            Object.keys(cidadesPorUF).forEach((uf) => {
              cidadesPorUF[uf].sort((a, b) => a.localeCompare(b, "pt-BR"));
            });
          })
          .catch((erro) => {
            console.error("Erro ao carregar estados/cidades:", erro);
          });

        lstUf.addEventListener("change", () => {
          const uf = lstUf.value;
          campoCidades.innerHTML = "";
          if (!uf) {
            campoCidades.innerHTML =
              '<span id="msg-cidade-placeholder" style="color:#8b949e; font-size:1rem;">Selecione uma cidade</span>';
            msgCidadeInfo.style.display = "none";
            return;
          }
          const cidades = cidadesPorUF[uf];
          if (cidades && Array.isArray(cidades)) {
            cidades.slice(0, 1000).forEach((cidade) => {
              const label = document.createElement("label");
              label.style.display = "flex";
              label.style.alignItems = "center";
              label.style.gap = "0.5em";
              label.style.fontSize = "1rem";
              label.innerHTML = `<input type='checkbox' name='cidades' value='${cidade}' style='accent-color:var(--primary); width:1.1em; height:1.1em;'> <span>${cidade}</span>`;
              campoCidades.appendChild(label);
            });
            msgCidadeInfo.style.display = "block";
          } else {
            campoCidades.innerHTML =
              '<span style="color:#8b949e;">Nenhuma cidade encontrada</span>';
            msgCidadeInfo.style.display = "none";
          }

          // Limite máximo 3 cidades
          campoCidades
            .querySelectorAll("input[type='checkbox']")
            .forEach((cb) => {
              cb.addEventListener("change", function () {
                const selecionados = campoCidades.querySelectorAll(
                  "input[type='checkbox']:checked"
                );
                if (selecionados.length > 3) {
                  this.checked = false;
                  mensagem.textContent = "Selecione no máximo 3 cidades.";
                  mensagem.style.color = "#df5252";
                  setTimeout(() => {
                    mensagem.textContent = "";
                  }, 2000);
                }
              });
            });
        });

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          mensagem.style.color = "#df5252";
          mensagem.textContent = "";

          const nome = document.getElementById("txtNome").value.trim();
          const email = document.getElementById("txtEmail").value.trim();
          const senha = document.getElementById("txtSenha").value.trim();
          const pergunta = document.getElementById("txtPerguntaSeguranca").value.trim();
          const resposta = document.getElementById("txtRespostaSeguranca").value.trim();
          const perfilSocial = document.getElementById("txtPerfilSocial").value.trim();
          const termos = document.getElementById("chkTermos").checked;

          if (!termos) {
            mensagem.textContent = "Você precisa aceitar os Termos de uso e Condições.";
            return;
          }

          if (!nome || !email || !senha || !pergunta || !resposta || !perfilSocial) {
            mensagem.textContent = "Preencha todos os campos obrigatórios.";
            return;
          }

          const cidadesSelecionadas = Array.from(
            campoCidades.querySelectorAll("input[type='checkbox']:checked")
          ).map((input) => input.value);

          if (cidadesSelecionadas.length === 0) {
            mensagem.textContent = "Selecione pelo menos uma cidade.";
            return;
          }
          if (cidadesSelecionadas.length > 3) {
            mensagem.textContent = "Selecione no máximo 3 cidades.";
            return;
          }

          // Normaliza resposta de segurança
          const respostaNormalizada = limparRespostaSeguranca(resposta);

          mensagem.style.color = varPrimary();
          mensagem.textContent = "Processando cadastro...";

          try {
            // Inicializa Firebase (ajuste sua configuração no firebase-config.js ou aqui)
            if (!firebase.apps.length) {
              firebase.initializeApp({
                apiKey: "SUA_API_KEY",
                authDomain: "SEU_AUTH_DOMAIN",
                projectId: "SEU_PROJECT_ID",
                // outras configs
              });
            }
            const auth = firebase.auth();
            const db = firebase.firestore();

            // Cria usuário
            const userCredential = await auth.createUserWithEmailAndPassword(
              email,
              senha
            );
            const user = userCredential.user;

            // Salva dados no Firestore
            await db.collection("usuarios").doc(user.uid).set({
              nome: nome,
              email: email,
              perfilSocial: perfilSocial,
              perguntaSeguranca: pergunta,
              respostaSeguranca: respostaNormalizada,
              estados: lstUf.value,
              cidades: cidadesSelecionadas,
              criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
            });

            mensagem.style.color = "#2ea043";
            mensagem.textContent = "Cadastro realizado com sucesso! Redirecionando...";
            setTimeout(() => {
              window.location.href = "index.html";
            }, 2000);
          } catch (error) {
            console.error("Erro no cadastro:", error);
            mensagem.style.color = "#df5252";
            mensagem.textContent = "Erro ao cadastrar: " + error.message;
          }
        });

        function varPrimary() {
          return getComputedStyle(document.documentElement).getPropertyValue(
            "--primary"
          );
        }
      });
    </script>
    <div id="rodape"></div>
    <script>
      fetch("rodape.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("rodape").innerHTML = html;
        });
    </script>
    <!-- Firebase scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  </body>
</html>