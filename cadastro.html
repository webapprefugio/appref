<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Cadastrar | WebApp Refúgios</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link rel="icon" href="assets/img/favicon.ico" type="image/x-icon" />

      <nav class="navbar">
    <div class="logo"></div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="cadastro.html">Cadastro</a></li>
      <li><a href="login.html">Login</a></li>
      <li><a href="sobre.html">Sobre</a></li>
    </ul>
  </nav>
    
  </head>
  <body>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        fetch("menu.html")
          .then((res) => res.text())
          .then((html) => {
            document.getElementById("menu").innerHTML = html;
            const currentPage = location.pathname.split("/").pop();
            document.querySelectorAll(".nav-links a").forEach((link) => {
              if (link.getAttribute("href") === currentPage) {
                // link.classList.add("active"); // Removido: estilização via classe
              }
            });
          })
          .catch((err) => console.error("Erro ao carregar menu:", err));
      });
    </script>
    <main>
      <div class="container">
        <h1>Cadastre-se</h1>
        <form class="formulario" id="formCadastro">
          <div>
            <input type="checkbox" id="chkTermos" required />
            &nbsp;&nbsp;Concordo com os
            <a href="termos.html">&nbsp;Termos de uso e Condições</a>
          </div>
          <input type="text" placeholder="Link do seu Perfil Social" required id="txtPerfilSocial" />
          <input type="text" placeholder="Nome de usuário" required id="txtNome" />
          <input type="email" placeholder="E-mail" required id="txtEmail" />
          <input type="password" placeholder="Senha" required id="txtSenha" />
          <label for="perguntaSeguranca">Pergunta de Segurança</label>
          <input type="text" placeholder="Pergunte o que só você saberá responder" required id="txtPerguntaSeguranca" />
          <input type="text" placeholder="Resposta à pergunta de segurança" required id="txtRespostaSeguranca" />
          <label for="lstUf">Locais dos Refúgios</label>
          <select id="lstUf" required>
            <option value="" disabled selected>Selecione um Estado</option>
          </select>
          <div id="campo-cidades">
            <span id="msg-cidade-placeholder">Selecione uma cidade</span>
          </div>
          <div id="msg-cidade-info">
            Selecione no máximo 3 cidades
          </div>
          <div id="mensagem"></div>
          <button type="submit">Cadastrar</button>
          <button type="button" class="alt-btn" onclick="window.location.href='index.html'">
            Cancelar
          </button>
          <p>
            Já possui uma conta?
            <a href="login.html">Entrar</a>
          </p>
        </form>
      </div>
    </main>
    <script>
      // Forçar sugestões no select2 se for usado (não usado atualmente)
      function forcarSugestoes(input) {
        const valor = input.value;
        input.value = "";
        setTimeout(() => {
          input.value = valor;
        }, 1);
      }

      // Função para normalizar a resposta da pergunta de segurança
      function limparRespostaSeguranca(valor) {
        return valor
          .normalize("NFD") // separa acentos
          .replace(/[\u0300-\u036f]/g, "") // remove acentos
          .replace(/\s+/g, "") // remove espaços
          .toLowerCase(); // letras minúsculas
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Carregando menu já feito acima

        // Elementos
        const lstUf = document.getElementById("lstUf");
        const campoCidades = document.getElementById("campo-cidades");
        const msgCidadeInfo = document.getElementById("msg-cidade-info");
        const mensagem = document.getElementById("mensagem");
        const form = document.getElementById("formCadastro");

        let cidadesPorUF = {};

        // Carregar JSONs com estados e cidades
        Promise.all([
          fetch("json/ufs.json").then((res) => res.json()),
          fetch("json/cidades.json").then((res) => res.json()),
        ])
          .then(([estados, cidades]) => {
            const stateIdToAbbr = {};
            estados
              .sort((a, b) => a.name.localeCompare(b.name, "pt-BR"))
              .forEach((estado) => {
                stateIdToAbbr[estado.id] = estado.abbr;
                const opt = document.createElement("option");
                opt.value = estado.abbr;
                opt.textContent = estado.name;
                lstUf.appendChild(opt);
              });

            cidades.forEach((cidade) => {
              const uf = stateIdToAbbr[cidade.state_id];
              if (!uf) return;
              if (!cidadesPorUF[uf]) cidadesPorUF[uf] = [];
              cidadesPorUF[uf].push(cidade.name);
            });

            Object.keys(cidadesPorUF).forEach((uf) => {
              cidadesPorUF[uf].sort((a, b) => a.localeCompare(b, "pt-BR"));
            });
          })
          .catch((erro) => {
            console.error("Erro ao carregar estados/cidades:", erro);
          });

        lstUf.addEventListener("change", () => {
          const uf = lstUf.value;
          campoCidades.innerHTML = "";
          if (!uf) {
            campoCidades.innerHTML =
              '<span id="msg-cidade-placeholder">Selecione uma cidade</span>';
            // msgCidadeInfo.style.display = "none"; // Removido: estilização inline
            return;
          }
          const cidades = cidadesPorUF[uf];
          if (cidades && Array.isArray(cidades)) {
            cidades.slice(0, 1000).forEach((cidade) => {
              const label = document.createElement("label");
              // label.style.display = "flex"; // Removido: estilização inline
              // label.style.alignItems = "center"; // Removido: estilização inline
              // label.style.gap = "0.5em"; // Removido: estilização inline
              // label.style.fontSize = "1rem"; // Removido: estilização inline
              label.innerHTML = `<input type='checkbox' name='cidades' value='${cidade}'> <span>${cidade}</span>`; // accent-color e width/height removidos do input
              campoCidades.appendChild(label);
            });
            // msgCidadeInfo.style.display = "block"; // Removido: estilização inline
          } else {
            campoCidades.innerHTML =
              '<span>Nenhuma cidade encontrada</span>';
            // msgCidadeInfo.style.display = "none"; // Removido: estilização inline
          }

          // Limite máximo 3 cidades
          campoCidades
            .querySelectorAll("input[type='checkbox']")
            .forEach((cb) => {
              cb.addEventListener("change", function () {
                const selecionados = campoCidades.querySelectorAll(
                  "input[type='checkbox']:checked"
                );
                if (selecionados.length > 3) {
                  this.checked = false;
                  mensagem.textContent = "Selecione no máximo 3 cidades.";
                  // mensagem.style.color = "#df5252"; // Removido: estilização inline
                  setTimeout(() => {
                    mensagem.textContent = "";
                  }, 2000);
                }
              });
            });
        });

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          // mensagem.style.color = "#df5252"; // Removido: estilização inline
          mensagem.textContent = "";

          const nome = document.getElementById("txtNome").value.trim();
          const email = document.getElementById("txtEmail").value.trim();
          const senha = document.getElementById("txtSenha").value.trim();
          const pergunta = document.getElementById("txtPerguntaSeguranca").value.trim();
          const resposta = document.getElementById("txtRespostaSeguranca").value.trim();
          const perfilSocial = document.getElementById("txtPerfilSocial").value.trim();
          const termos = document.getElementById("chkTermos").checked;

          if (!termos) {
            mensagem.textContent = "Você precisa aceitar os Termos de uso e Condições.";
            return;
          }

          if (!nome || !email || !senha || !pergunta || !resposta || !perfilSocial) {
            mensagem.textContent = "Preencha todos os campos obrigatórios.";
            return;
          }

          const cidadesSelecionadas = Array.from(
            campoCidades.querySelectorAll("input[type='checkbox']:checked")
          ).map((input) => input.value);

          if (cidadesSelecionadas.length === 0) {
            mensagem.textContent = "Selecione pelo menos uma cidade.";
            return;
          }
          if (cidadesSelecionadas.length > 3) {
            mensagem.textContent = "Selecione no máximo 3 cidades.";
            return;
          }

          // Normaliza resposta de segurança
          const respostaNormalizada = limparRespostaSeguranca(resposta);

          // mensagem.style.color = varPrimary(); // Removido: função de estilo
          mensagem.textContent = "Processando cadastro...";

          try {
            // Inicializa Firebase (ajuste sua configuração no firebase-config.js ou aqui)
            if (!firebase.apps.length) {
              firebase.initializeApp({
                apiKey: "SUA_API_KEY",
                authDomain: "SEU_AUTH_DOMAIN",
                projectId: "SEU_PROJECT_ID",
                // outras configs
              });
            }
            const auth = firebase.auth();
            const db = firebase.firestore();

            // Cria usuário
            const userCredential = await auth.createUserWithEmailAndPassword(
              email,
              senha
            );
            const user = userCredential.user;

            // Salva dados no Firestore
            await db.collection("usuarios").doc(user.uid).set({
              nome: nome,
              email: email,
              perfilSocial: perfilSocial,
              perguntaSeguranca: pergunta,
              respostaSeguranca: respostaNormalizada,
              estados: lstUf.value,
              cidades: cidadesSelecionadas,
              criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
            });

            // mensagem.style.color = "#2ea043"; // Removido: estilização inline
            mensagem.textContent = "Cadastro realizado com sucesso! Redirecionando...";
            setTimeout(() => {
              window.location.href = "index.html";
            }, 2000);
          } catch (error) {
            console.error("Erro no cadastro:", error);
            // mensagem.style.color = "#df5252"; // Removido: estilização inline
            mensagem.textContent = "Erro ao cadastrar: " + error.message;
          }
        });

        // function varPrimary() { // Removida: função de estilo
        //   return getComputedStyle(document.documentElement).getPropertyValue(
        //     "--primary"
        //   );
        // }
      });
    </script>
    <footer>
      <div>
        <a href="cadastro.html">Junte-se a nós!</a>
      </div>
      &copy; 2025 - WebApp Encontre seu Refúgio
    </footer>
    </script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  </body>
</html>