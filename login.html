<!DOCTYPE html>
<html lang="pt-br">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
      <title>Login | WebApp Refúgios</title>
      <link rel="icon" href="assets/img/favicon.ico" type="image/x-icon" />
      <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
      <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
      <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
      <link rel="stylesheet" href="style/style.css" />
      <link rel="stylesheet" href="style/login.css" />
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="all" onload="this.media='all'" />
   </head>
   <body>
      <nav class="menu">
         <ul class="menu-links">
            <li><a href="index.html"><i class="fas fa-house"></i><span>Home</span></a></li>
            <li><a href="login.html" class="ativo"><i class="fas fa-user"></i><span>Membros</span></a></li>
            <li><a href="galeriavideos.html"><i class="fas fa-photo-film"></i><span>Galeria</span></a></li>
            <li><a href="sobre.html"><i class="fas fa-circle-info"></i><span>Sobre</span></a></li>
         </ul>
      </nav>
      <main>
         <div class="container">
            <h1>Entrar</h1>
            <form class="formulario">
               <input type="email" id="email" placeholder="E-mail" required />
               <input type="password" id="senha" placeholder="Senha" required />
               <button type="submit">Entrar</button>
               <button type="button" class="alt-btn" onclick="window.location.href='index.html'">Cancelar</button>
               <div>
                  <br />
                  <p>Ainda não possui conta?&nbsp;&nbsp;<a href="cadastro.html">Cadastre-se</a></p>
                  <br />
                  <p>Esqueceu sua senha?&nbsp;&nbsp;<a href="alterarsenha.html">Clique aqui</a></p>
               </div>
            </form>
            <div id="area-consulta" style="display: none;"></div>
         </div>
      </main>
      <footer>
         <div><a href="cadastro.html">Junte-se a nós!</a></div>
         <br />
         &copy; 2025 - WebApp Refúgios (V. 1.0)
      </footer>
      <script>
         const firebaseConfig = {
           apiKey: "AIzaSyCzg9Pr8-7UGv7f451Vx30WpzwRcsGd_qs",
           authDomain: "appref-projeto.firebaseapp.com",
           projectId: "appref-projeto",
           storageBucket: "appref-projeto.appspot.com",
           messagingSenderId: "80380853942",
           appId: "1:80380853942:web:2320fa16fa06f2ffa77017"
         };
         
         if (!firebase.apps.length) {
           firebase.initializeApp(firebaseConfig);
         }
         
         const db = firebase.firestore();
         const auth = firebase.auth();
         
         function showLoginMessage(msg) {
           let msgDiv = document.getElementById('login-msg');
           const form = document.querySelector('.formulario');
           if (!msgDiv) {
             msgDiv = document.createElement('div');
             msgDiv.id = 'login-msg';
             form.insertBefore(msgDiv, form.querySelector('button'));
           }
           msgDiv.textContent = msg;
         }
         
         function renderConsulta(saudacaoHtml, nomeUsuario) {
           const areaConsulta = document.getElementById('area-consulta');
           areaConsulta.innerHTML = `
             ${saudacaoHtml}
             <div><button id="btnLogout">Sair</button></div>
             <div id="msg-excluir" style="color: red; font-weight: bold; margin-top: 10px;"></div>
             <div>
               <table>
                 <thead>
                   <tr>
                     <th>Perfil Social</th>
                     <th>Nome</th>
                     <th>UF</th>
                     <th>Cidade</th>
                   </tr>
                 </thead>
                 <tbody id="tabela-usuarios"></tbody>
               </table>
             </div>
            <div><br>
              <button id="excluirconta">
                Clique aqui para excluir sua conta.<br />Esse processo, uma vez iniciado, é irreversível!
              </button>
            </div>

           `;
         
           const tabela = document.getElementById('tabela-usuarios');
         
         db.collection("usuarios").get().then(snapshot => {
         tabela.innerHTML = "";
         const cidadesUsuario = [];
         const emailUsuario = auth.currentUser.email;
         console.log("Email logado:", emailUsuario);
         
         // Primeiro: capturar as cidades do usuário logado
         snapshot.forEach(doc => {
         const u = doc.data();
         if ((u.email || "").trim().toLowerCase() === emailUsuario.trim().toLowerCase()) {
           console.log("Usuário logado encontrado:", u);
         
           if (Array.isArray(u.cidades)) {
             u.cidades.forEach(c => {
               if (typeof c === 'string') {
                 cidadesUsuario.push(c.trim().toLowerCase());
               }
             });
           } else {
             console.warn("⚠️ Usuário logado não tem cidades definidas como array no Firestore.");
           }
         }
         });
         
         // Segundo: filtrar os usuários para exibir na tabela
         const registros = [];
         snapshot.forEach(doc => {
         const u = doc.data();
         if (!u.email || !u.uf || !u.cidades || !Array.isArray(u.cidades) || !u.linkPerfil || !u.nome) return;
         
         const cidadeIgual = u.cidades.some(c => cidadesUsuario.includes(c.trim().toLowerCase()));
         const mesmoUsuario = (u.email || "").trim().toLowerCase() === emailUsuario.trim().toLowerCase();
         
         if (cidadeIgual || mesmoUsuario) {
           registros.push(u);
         }
         });
         
         // ... continua com o código para agrupar por UF e exibir na tabela
         
         console.log("Registros que serão exibidos:", registros);
         
         
             const agrupadoPorUF = {};
             registros.forEach(u => {
               const uf = (u.uf || u.estados || "").toUpperCase();
               if (!agrupadoPorUF[uf]) agrupadoPorUF[uf] = [];
               agrupadoPorUF[uf].push(u);
             });
         
         
             for (const uf in agrupadoPorUF) {
               const grupo = agrupadoPorUF[uf];
               for (let i = grupo.length - 1; i > 0; i--) {
                 const j = Math.floor(Math.random() * (i + 1));
                 [grupo[i], grupo[j]] = [grupo[j], grupo[i]];
               }
             }
         
             const ufsOrdenadas = Object.keys(agrupadoPorUF).sort();
             ufsOrdenadas.forEach(uf => {
               tabela.innerHTML += `<tr><td colspan="4">Estado: ${uf}</td></tr>`;
         agrupadoPorUF[uf].forEach(usuario => {
         (usuario.cidades || []).forEach(cidade => {
         if (cidadesUsuario.includes(cidade.trim().toLowerCase())) {
           tabela.innerHTML += `
             <tr>
               <td><a href="${usuario.linkPerfil}" target="_blank" rel="noopener">Contacte-me</a></td>
               <td>${usuario.nome}</td>
               <td>${usuario.uf}</td>
               <td>${cidade}</td>
             </tr>`;
         }
         });
         });
         
             });
           }).catch(() => {
             tabela.innerHTML = '<tr><td colspan="4">Erro ao carregar dados.</td></tr>';
           });
         
           document.getElementById('btnLogout').onclick = function () {
             auth.signOut().then(() => {
               localStorage.removeItem('userCity');
               window.location.reload();
             });
           };
         
           document.getElementById('excluirconta').onclick = function () {
             const user = auth.currentUser;
             const msgDiv = document.getElementById('msg-excluir');
             msgDiv.textContent = 'Processando exclusão...';
         
             user.delete().then(() => {
               window.location.href = 'contaexcluida.html';
             }).catch(error => {
               if (error.code === 'auth/requires-recent-login') {
                 msgDiv.textContent = 'Por segurança, refaça o login para excluir sua conta.';
                 auth.signOut().then(() => window.location.reload());
               } else {
                 msgDiv.textContent = 'Erro ao excluir conta: ' + error.message;
               }
             });
           };
         }
         
         function carregarConsulta() {
           const user = auth.currentUser;
           if (!user) return;
         
           db.collection("usuarios").where("email", "==", user.email).limit(1).get().then(snapshot => {
             let nome = '';
             let cidadeUsuario = '';
             if (!snapshot.empty) {
               const userData = snapshot.docs[0].data();
               nome = userData.nome || '';
               
               localStorage.setItem('userCity', cidadeUsuario);
             }
             const saudacao = nome ? `<div>Paz e Bem,&nbsp;<span>${nome}</span>!</div>` : '';
             renderConsulta(saudacao, nome);
           }).catch(error => {
             console.error("Erro ao buscar dados do usuário:", error);
             renderConsulta('', '');
           });
         }
         
         window.addEventListener('DOMContentLoaded', () => {
           const loginForm = document.querySelector('.formulario');
           const areaConsulta = document.getElementById('area-consulta');
         
           loginForm.addEventListener('submit', function (e) {
             e.preventDefault();
             const email = document.getElementById('email').value.trim();
             const senha = document.getElementById('senha').value.trim();
         
             if (!email || !senha) {
               showLoginMessage('Preencha todos os campos.');
               return;
             }
         
             firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
               .then(() => {
                 return auth.signInWithEmailAndPassword(email, senha);
               })
               .then(() => {
                 showLoginMessage('');
                 loginForm.style.display = 'none';
                 areaConsulta.style.display = 'block';
                 carregarConsulta();
               })
               .catch(error => {
                 showLoginMessage('E-mail ou senha inválidos.');
                 console.error(error);
               });
           });
         
           auth.onAuthStateChanged(user => {
             if (user) {
               document.querySelector('.formulario').style.display = 'none';
               areaConsulta.style.display = 'block';
               carregarConsulta();
             } else {
               document.querySelector('.formulario').style.display = 'flex';
               areaConsulta.style.display = 'none';
               localStorage.removeItem('userCity');
             }
           });
         });
      </script>
      <script>
         document.addEventListener("DOMContentLoaded", () => {
           const larguraTela = window.innerWidth;
           const container = document.querySelector('.container');
         
           if (larguraTela < 280) {
             container.style.width = larguraTela + "px";
             container.style.maxWidth = larguraTela + "px";
             container.style.padding = "10px";
           }
         });
      </script>
   </body>
</html>