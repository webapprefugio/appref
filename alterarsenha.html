<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Alterar Senha | WebApp Refúgios</title>
  <link rel="icon" href="assets/img/favicon.ico" type="image/x-icon" />

    <nav class="navbar">
    <div class="logo"></div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="cadastro.html">Cadastro</a></li>
      <li><a href="login.html">Login</a></li>
      <li><a href="sobre.html">Sobre</a></li>
    </ul>
  </nav>


</head>
<body>

  </script>

  <main>
    <div class="container">
      <h1>Alterar Senha</h1>
      <form class="formulario" id="formAlterarSenha">
        <input type="email" placeholder="Email" id="email" required />

        <div id="perguntaContainer">
          <div>
            <label id="perguntaSeguranca"></label>
            <input type="text" id="respostaUsuario" placeholder="Digite sua resposta" />
          </div>
        </div>

        <div id="mensagem"></div>

        <button type="submit">Alterar Senha</button>
        <button
          type="button"
          class="alt-btn"
          onclick="window.location.href='index.html'"
        >
          Cancelar
        </button>
      </form>
    </div>
  </main>

    <footer>
      <div>
        <a href="cadastro.html">Junte-se a nós!</a>
      </div>
      &copy; 2025 - WebApp Encontre seu Refúgio
    </footer>
  </script>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: 'AIzaSyCzg9Pr8-7UGv7f451Vx30WpzwRcsGd_qs',
      authDomain: 'appref-projeto.firebaseapp.com',
      projectId: 'appref-projeto',
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function normalizarTexto(str) {
      return str
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/\s+/g, '')
        .toLowerCase();
    }

    document.getElementById('email').addEventListener('blur', async function () {
      const email = this.value.trim().toLowerCase();
      const mensagem = document.getElementById('mensagem');
      mensagem.textContent = '';
      if (!email) {
        document.getElementById('perguntaContainer').style.display = 'none'; // Mantido: é uma funcionalidade de exibição, não estilização puramente visual
        return;
      }

      try {
        const query = await db
          .collection('usuarios')
          .where('email', '==', email)
          .limit(1)
          .get();
        if (query.empty) {
          mensagem.textContent = 'E-mail não encontrado.';
          document.getElementById('perguntaContainer').style.display = 'none'; // Mantido
          return;
        }
        const doc = query.docs[0].data();
        document.getElementById('perguntaSeguranca').textContent =
          doc.perguntaSeguranca || '';
        document.getElementById('perguntaContainer').style.display = 'block'; // Mantido
      } catch (erro) {
        mensagem.textContent = 'Erro ao buscar pergunta de segurança.';
        document.getElementById('perguntaContainer').style.display = 'none'; // Mantido
      }
    });

    document
      .getElementById('formAlterarSenha')
      .addEventListener('submit', async function (e) {
        e.preventDefault();
        const email = document.getElementById('email').value.trim().toLowerCase();
        const resposta = document.getElementById('respostaUsuario').value.trim();
        const mensagem = document.getElementById('mensagem');
        // mensagem.style.color = 'var(--color-error)'; // Removido: estilização inline
        mensagem.textContent = '';

        if (!email || !resposta) {
          mensagem.textContent = 'Preencha o e-mail e a resposta.';
          return;
        }

        try {
          const query = await db
            .collection('usuarios')
            .where('email', '==', email)
            .limit(1)
            .get();
          if (query.empty) {
            mensagem.textContent = 'E-mail não encontrado.';
            return;
          }

          const doc = query.docs[0].data();
          const respostaSalva = doc.respostaSeguranca || '';
          const respostaNormalizada = normalizarTexto(resposta);

          if (respostaNormalizada !== respostaSalva) {
            mensagem.textContent = '❌ Resposta incorreta.';
            return;
          }

          auth
            .sendPasswordResetEmail(email)
            .then(() => {
              // mensagem.style.color = 'var(--color-primary)'; // Removido: estilização inline
              mensagem.innerHTML = `✅ Link de redefinição enviado para o seu e-mail.<br>Por favor, verifique também sua caixa de spam (lixo eletrônico).`;

              document.getElementById('email').style.display = 'none'; // Mantido: funcionalidade de exibição
              document.getElementById('perguntaContainer').style.display = 'none'; // Mantido

              document.querySelector('#formAlterarSenha button[type=submit]').style.display =
                'none'; // Mantido: funcionalidade de exibição
              document.querySelector('#formAlterarSenha button.alt-btn').style.display =
                'none'; // Mantido: funcionalidade de exibição

              mostrarBotaoLogin();
            })
            .catch((error) => {
              console.error(error);
              mensagem.textContent = 'Erro ao enviar o e-mail de redefinição.';
            });
        } catch (erro) {
          console.error(erro);
          mensagem.textContent = 'Erro ao verificar dados.';
        }
      });

    function mostrarBotaoLogin() {
      const container = document.querySelector('.container');
      if (document.getElementById('btnLogin')) return;

      const btn = document.createElement('button');
      btn.id = 'btnLogin';
      btn.textContent = 'Ir para Login';
      // btn.className = 'alt-btn'; // Removido: estilização via classe
      // btn.style.marginTop = '1rem'; // Removido: estilização inline
      btn.onclick = () => (window.location.href = 'login.html');

      container.appendChild(btn);
    }
  </script>
</body>
</html>